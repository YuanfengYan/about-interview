# 前端异常监控

## 一、 行为设计步骤


日志采集、日志存储、统计与分析、报告和警告。

## 二、 前端异常分类

- 逻辑错误	  1)    业务逻辑判断条件错误 2)    事件绑定顺序错误 3)    调用栈时序错误 4)    错误的操作js对象

- 数据类型错误  1)    将null视作对象读取property 2)    将undefined视作数组进行遍历 3)    将字符串形式的数字直接用于加运算 4)    函数参数未传

- 语法句法错误

- 网络错误    	1)    慢 2)    服务端未返回数据但仍200，前端按正常进行数据遍历 3)    提交数据时网络中断 4)    服务端500错误时前端未做任何错误处理

- 系统错误  1)    内存不够用 2)    磁盘塞满 3)    壳不支持API 4)    不兼容



## 三、 采集内容

-  用户信息

- 行为信息 

- 异常信息

- 环境信息 

## 四、异常捕获方式

**前端捕获异常分为全局捕获和单点捕获**

### 1 全局捕获 -- 通过全局的接口，将捕获代码集中写在一个地方

1. window.addEventListener('error') / window.addEventListener("unhandledrejection") / document.addEventListener('click') 等

2. 框架级别的全局监听，例如aixos中使用interceptor进行拦截，vue、react都有自己的错误采集接口

3. 通过对全局函数进行封装包裹，实现在在调用该函数时自动捕获异常

4. 对实例方法重写（Patch），在原有功能基础上包裹一层，例如对console.error进行重写，在使用方法不变的情况下也可以异常捕获


### 2 单点捕获 --- 在业务代码中对单个代码块进行包裹，或在逻辑流程中打点，实现有针对性的异常捕获：

1. try…catch
 
2. 专门写一个函数来收集异常信息，在异常发生时，调用该函数

3. 专门写一个函数来包裹其他函数，得到一个新函数，该新函数运行结果和原函数一模一样，只是在发生异常时可以捕获异常 / 可以理解通过AOP装饰者模式 在代码中添加埋点。

## 五、异常录制

## 六、 异常级别

## 七 上报日志

- 即时上报
- 批量上报
- 区块上报
- 用户主动提交


## 八、 压缩上报数据  -- 减少流量消耗

lz-string是一个非常优秀的字符串压缩类库，兼容性好，代码量少，压缩比高，压缩时间短，压缩率达到惊人的60%。

但它基于LZ78压缩，如果后端不支持解压，可选择gzip压缩，一般而言后端会默认预装gzip，因此，选择gzip压缩数据也可以，工具包pako中自带了gzip压缩，可以尝试使用。

## 九、 日志接收与存储

  提供独立的日志服务器接收客户端日志，接收过程中，要对客户端日志内容的合法性、安全性等进行甄别，防止被人攻击
  通过消息队列将日志信息逐一处理后写入到数据库进行保存也是比较常用的方案。



  日志存储方案，主要有：Hbase系，Dremel系，Lucene系等

  一般一套日志存储系统，要解决上面这些问题，就要解决写入的缓冲，存储介质按日志时间选择，为方便快速读取而设计合理的索引系统等等

## 十、 日志统计与分析

- 用户纬度
- 时间维度
- 性能维度
- 运行环境维度
-  细粒度代码追踪
-   场景回溯


## 十一、 监控与通知

**配置的自定义触发条件:**
+ 日志内含有什么内容时
+ 日志统计达到什么度、量时
+ 向符合什么条件的用户告警

当达到一定的触发条件，推送到接入的飞书，短信等渠道

## 其他：见参考文档 [前端异常监控解决方案研究](https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/)



## 项目中使用的异常日志监控 Sentry



## 参考文档

+ [前端异常监控解决方案研究](https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/)
+ 
+ [前端异常日志监控 - 使用Sentry ](https://www.cnblogs.com/xakoy/p/9636393.html)
